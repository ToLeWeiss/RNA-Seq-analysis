configfile: "config/config.yaml"

report: "report/workflow.rst"

dataset = config["geo_dataset"]

rule all:
        input:
                f"results/{dataset}/summary.pdf",


rule load_and_annotate_data:
        conda:
                "envs/data_loading.yaml"
        output:
                report(
                        [f"tmp/{dataset}/norm_counts.csv",
                        f"tmp/{dataset}/clindata.csv",
                        f"tmp/{dataset}/raw_counts.txt"],
                        caption="report/data_loading_and_annotation.rst",
                        category="Step 1"
                )
        script:
                "scripts/data_loading_and_annotation.R"


rule plot_MX1:
        conda:
                "envs/plotting.yaml"
        input:
                f"tmp/{dataset}/norm_counts.csv",
                f"tmp/{dataset}/clindata.csv"
        output:
                report(
                        f"results/{dataset}/MX1_plot.pdf",
                        caption="report/MX1_plot.rst", 
                        category="Step 2"
                )
        script:
                "scripts/plot_MX1.R"


rule spearman_correlation:
        conda:
                "envs/spearman_correlation.yaml"
        input:
                f"tmp/{dataset}/norm_counts.csv",
                f"tmp/{dataset}/clindata.csv"
        output:
                report(
                        f"results/{dataset}/spearman_correlation.txt",
                        caption="report/spearman_correlation.rst",
                        category="Step 3"
                )
        script:
                "scripts/spearman_correlation.R"


rule wilcoxon_test:
        conda:
                "envs/wilcoxon_and_jonckheere_test.yaml"
        input:
                f"tmp/{dataset}/norm_counts.csv",
                f"tmp/{dataset}/clindata.csv"
        output:
                report(
                        f"results/{dataset}/wilcoxon_test.txt",
                        caption="report/wilcoxon_test.rst",
                        category="Step 3"
                )
        script:
                "scripts/wilcoxon_test.R"


rule jonckheere_test:
        conda:
                "envs/wilcoxon_and_jonckheere_test.yaml"
        input:
                f"tmp/{dataset}/norm_counts.csv",
                f"tmp/{dataset}/clindata.csv"
        output:
                report(
                        f"results/{dataset}/jonckheere_test.txt",
                        caption="report/jonckheere_test.rst",
                        category="Step 4"
                )
        script:
                "scripts/jonckheere_test.R"


rule plot_MX1_MX2:
        conda:
                "envs/plotting.yaml"
        input:
                f"tmp/{dataset}/norm_counts.csv",
                f"tmp/{dataset}/clindata.csv"
        output:
                report(
                        f"results/{dataset}/MX1_MX2_plot.pdf",
                        caption="report/MX1_MX2_plot.rst",
                        category="Step 5"
                )
        script:
                "scripts/plot_MX1_MX2.R"


rule spearman_correlation_to_pdf:
        conda:
                "envs/txt_to_pdf.yaml"
        input:
                f"results/{dataset}/spearman_correlation.txt"
        output:
                report(
                        f"results/{dataset}/spearman_correlation.pdf",
                        caption="report/txt_to_pdf.rst",
                )
        shell:
                "pandoc {input} -o {output} --pdf-engine=tectonic"


rule wilcoxon_test_to_pdf:
        conda:
                "envs/txt_to_pdf.yaml"
        input:
                f"results/{dataset}/wilcoxon_test.txt"
        output:
                report(
                        f"results/{dataset}/wilcoxon_test.pdf",
                        caption="report/txt_to_pdf.rst",
                )
        shell:
                "pandoc {input} -o {output} --pdf-engine=tectonic"


rule jonckheere_test_to_pdf:
        conda:
                "envs/txt_to_pdf.yaml"
        input:
                f"results/{dataset}/jonckheere_test.txt"
        output:
                report(
                        f"results/{dataset}/jonckheere_test.pdf",
                        caption="report/txt_to_pdf.rst",
                )
        shell:
                "pandoc {input} -o {output} --pdf-engine=tectonic"


rule PCA_biplot:
        conda:
                "envs/PCA_biplot.yaml"
        input:
                f"tmp/{dataset}/norm_counts.csv",
                f"tmp/{dataset}/clindata.csv"
        output:
                report(
                        f"results/{dataset}/PCA_biplot.pdf",
                        caption="report/PCA_biplot.rst",
                        category="Step 5"
                )
        script:
                "scripts/PCA_biplot.R"


rule plot_of_PCA:
        conda:
                "envs/3D_plot.yaml"
        input:
                f"tmp/{dataset}/norm_counts.csv",
                f"tmp/{dataset}/clindata.csv"
        output:
                report(
                        f"results/{dataset}/3D_plot_of_PCA.pdf",
                        caption="report/3D_plot_of_PCA.rst",
                        category="Step 6"
                )
        script:
                "scripts/3D_plot_of_PCA.R"


rule histogram_of_selected_data:
        conda:
                "envs/only_r.yaml"
        input:
                f"tmp/{dataset}/norm_counts.csv",
                f"tmp/{dataset}/clindata.csv",
                f"tmp/{dataset}/raw_counts.txt"
        output:
                report(
                        f"results/{dataset}/histogram.pdf",
                        caption="report/histogram.rst",
                        category="Step 7"
                )
        script:
                "scripts/histogram.R"


rule pairwise_correlation:
        conda:
                "envs/pairwise_correlation.yaml"
        input:
                f"tmp/{dataset}/norm_counts.csv",
                f"tmp/{dataset}/clindata.csv"
        output:
                report(
                        f"results/{dataset}/pairwise_correlation.pdf",
                        caption="report/pairwise_correlation.rst",
                        category="Step 8"
                )
        script:
                "scripts/pairwise_correlation.R"


rule summarize_results:
        conda:
                "envs/summary.yaml"
        input:
                f"results/{dataset}/MX1_plot.pdf",
                f"results/{dataset}/MX1_MX2_plot.pdf",
                f"results/{dataset}/pairwise_correlation.pdf",
                f"results/{dataset}/PCA_biplot.pdf",
                f"results/{dataset}/3D_plot_of_PCA.pdf",
                f"results/{dataset}/spearman_correlation.pdf",
                f"results/{dataset}/wilcoxon_test.pdf",
                f"results/{dataset}/jonckheere_test.pdf",
                f"results/{dataset}/histogram.pdf"
        output:
                report(
                        f"results/{dataset}/summary.pdf",
                        caption="report/summary.rst",
                        category="Step 9"
                )
        script:
                "scripts/summarize_results.R"
